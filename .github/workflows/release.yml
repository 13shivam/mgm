name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run linter
        run: npm run lint

  build-and-release:
    needs: test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build DMG (Universal - Both Architectures)
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: |
          npm run build
          echo "‚úÖ Build completed"
          ls -lh dist/

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: List and Rename DMG files
        id: rename
        run: |
          cd dist
          echo "üì¶ Files in dist:"
          ls -la
          
          # Rename ARM64 if exists
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" ]; then
            mv "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg"
            echo "ARM_BUILT=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Renamed ARM64 DMG"
          else
            echo "ARM_BUILT=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ARM64 DMG not found"
          fi
          
          # Rename Intel if exists
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" ]; then
            mv "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg"
            echo "INTEL_BUILT=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Renamed Intel DMG"
          else
            echo "INTEL_BUILT=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Intel DMG not found"
          fi
          
          echo "üì¶ Renamed files:"
          ls -la

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          cd dist
          
          # Intel checksum
          if [ "${{ steps.rename.outputs.INTEL_BUILT }}" == "true" ]; then
            INTEL_SHA=$(shasum -a 256 "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg" | awk '{print $1}')
            echo "INTEL_SHA=$INTEL_SHA" >> $GITHUB_OUTPUT
            echo "‚úÖ Intel SHA256: $INTEL_SHA"
          else
            echo "INTEL_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Intel not built"
          fi
          
          # ARM checksum
          if [ "${{ steps.rename.outputs.ARM_BUILT }}" == "true" ]; then
            ARM_SHA=$(shasum -a 256 "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg" | awk '{print $1}')
            echo "ARM_SHA=$ARM_SHA" >> $GITHUB_OUTPUT
            echo "‚úÖ ARM SHA256: $ARM_SHA"
          else
            echo "ARM_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ARM not built"
          fi

      - name: Update Homebrew Formula
        id: update_formula
        run: |
          git clone https://github.com/13shivam/homebrew-mgm.git tap-repo
          cd tap-repo
          mkdir -p Casks
          cp ../homebrew/mgm.rb Casks/mgm.rb
          
          # Update version
          sed -i '' "s/version \".*\"/version \"${{ steps.version.outputs.VERSION }}\"/" Casks/mgm.rb
          
          # Update Intel SHA256
          if [ "${{ steps.checksums.outputs.INTEL_SHA }}" != "NOT_BUILT" ]; then
            sed -i '' "/Hardware::CPU.intel?/,/url.*Intel/ s/sha256 \"[^\"]*\"/sha256 \"${{ steps.checksums.outputs.INTEL_SHA }}\"/" Casks/mgm.rb
            echo "‚úÖ Updated Intel SHA256"
          fi
          
          # Update ARM SHA256
          if [ "${{ steps.checksums.outputs.ARM_SHA }}" != "NOT_BUILT" ]; then
            sed -i '' "/else/,/url.*AppleSilicon/ s/sha256 \"[^\"]*\"/sha256 \"${{ steps.checksums.outputs.ARM_SHA }}\"/" Casks/mgm.rb
            echo "‚úÖ Updated ARM SHA256"
          fi
          
          echo "üìÑ Updated formula:"
          cat Casks/mgm.rb

      - name: Commit and Push to Tap Repo
        id: commit_formula
        continue-on-error: true
        env:
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/mgm.rb
          
          if git diff --staged --quiet; then
            echo "COMMITTED=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No changes to commit"
          else
            git commit -m "chore: update mgm cask to v${{ steps.version.outputs.VERSION }}"
            git push https://${TAP_TOKEN}@github.com/13shivam/homebrew-mgm.git main
            echo "COMMITTED=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Homebrew tap updated"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
          body: |
            ## macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
            
            ‚ö†Ô∏è **Note:** This app is not code-signed. On first launch:
            1. Right-click the app ‚Üí "Open"
            2. Click "Open" in the security dialog
            3. Or: System Settings ‚Üí Privacy & Security ‚Üí "Open Anyway"
            
            ### Downloads
            ${{ steps.rename.outputs.ARM_BUILT == 'true' && '- ‚úÖ **Apple Silicon (M1/M2/M3)**: macOS-Gateway-Monitor-' || '- ‚ùå Apple Silicon: Not available' }}${{ steps.rename.outputs.ARM_BUILT == 'true' && steps.version.outputs.VERSION || '' }}${{ steps.rename.outputs.ARM_BUILT == 'true' && '-AppleSilicon.dmg' || '' }}
            ${{ steps.rename.outputs.INTEL_BUILT == 'true' && '- ‚úÖ **Intel**: macOS-Gateway-Monitor-' || '- ‚ùå Intel: Not available' }}${{ steps.rename.outputs.INTEL_BUILT == 'true' && steps.version.outputs.VERSION || '' }}${{ steps.rename.outputs.INTEL_BUILT == 'true' && '-Intel.dmg' || '' }}
            
            ### Installation
            
            **Via Homebrew (Recommended):**
            ```bash
            brew tap 13shivam/mgm
            brew install --cask mgm
            ```
            
            **Manual Installation:**
            1. Download the DMG for your Mac architecture
            2. Open the DMG file
            3. Drag "macOS Gateway Monitor.app" to Applications
            4. **Right-click** the app and select "Open" (first time only)
            
            ### Homebrew Formula
            ${{ steps.commit_formula.outputs.COMMITTED == 'true' && '‚úÖ Auto-updated with new checksums' || '‚ö†Ô∏è Manual update needed' }}
            
            ### SHA256 Checksums
            ```
            Apple Silicon: ${{ steps.checksums.outputs.ARM_SHA }}
            Intel: ${{ steps.checksums.outputs.INTEL_SHA }}
            ```
            
            ---
            [Documentation](https://github.com/13shivam/mgm#readme) | [Report Issue](https://github.com/13shivam/mgm/issues)
          files: |
            dist/macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg
            dist/macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
