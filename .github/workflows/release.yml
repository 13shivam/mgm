name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run linter
        run: npm run lint

  build-and-release:
    needs: test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build DMG (Universal - Both Architectures)
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: |
          npm run build
          echo "‚úÖ Build completed"
          ls -lh dist/

      - name: Ad-hoc Sign Apps (Remove Quarantine)
        run: |
          # Mount DMGs and sign the apps
          for dmg in dist/*.dmg; do
            if [ -f "$dmg" ]; then
              echo "Processing: $dmg"
              hdiutil attach "$dmg" -nobrowse -quiet
              
              # Find mounted app
              APP_PATH=$(find /Volumes -name "*.app" -maxdepth 2 2>/dev/null | grep "macOS Gateway Monitor" | head -1)
              
              if [ -n "$APP_PATH" ]; then
                echo "Signing: $APP_PATH"
                codesign --force --deep --sign - "$APP_PATH"
                
                # Detach and recreate DMG
                VOLUME=$(dirname "$APP_PATH")
                hdiutil detach "$VOLUME" -quiet
              fi
            fi
          done
          
          echo "‚úÖ Apps signed"
          ls -lh dist/

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare DMG files
        id: prepare
        run: |
          cd dist
          echo "üì¶ Original files:"
          ls -la
          
          # Just check what was built, don't rename yet
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" ]; then
            echo "ARM_FILE=macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" >> $GITHUB_OUTPUT
            echo "ARM_BUILT=true" >> $GITHUB_OUTPUT
            echo "‚úÖ ARM64 DMG found"
          else
            echo "ARM_BUILT=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ARM64 DMG not found"
          fi
          
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" ]; then
            echo "INTEL_FILE=macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" >> $GITHUB_OUTPUT
            echo "INTEL_BUILT=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Intel DMG found"
          else
            echo "INTEL_BUILT=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Intel DMG not found"
          fi

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          cd dist
          
          # Calculate from ORIGINAL files (before any renaming)
          if [ "${{ steps.prepare.outputs.INTEL_BUILT }}" == "true" ]; then
            INTEL_SHA=$(shasum -a 256 "${{ steps.prepare.outputs.INTEL_FILE }}" | awk '{print $1}')
            echo "INTEL_SHA=$INTEL_SHA" >> $GITHUB_OUTPUT
            echo "‚úÖ Intel SHA256: $INTEL_SHA"
          else
            echo "INTEL_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ steps.prepare.outputs.ARM_BUILT }}" == "true" ]; then
            ARM_SHA=$(shasum -a 256 "${{ steps.prepare.outputs.ARM_FILE }}" | awk '{print $1}')
            echo "ARM_SHA=$ARM_SHA" >> $GITHUB_OUTPUT
            echo "‚úÖ ARM SHA256: $ARM_SHA"
          else
            echo "ARM_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
          fi
          
          echo "üì¶ Final files to upload:"
          ls -la

      - name: Update Homebrew Formula
        id: update_formula
        run: |
          git clone https://github.com/13shivam/homebrew-mgm.git tap-repo
          cd tap-repo
          mkdir -p Casks
          
          # Create formula from scratch
          cat > Casks/mgm.rb << EOF
          cask "mgm" do
            version "${{ steps.version.outputs.VERSION }}"
            
            if Hardware::CPU.intel?
              sha256 "${{ steps.checksums.outputs.INTEL_SHA }}"
              url "https://github.com/13shivam/mgm/releases/download/v#{version}/macOS.Gateway.Monitor-#{version}-x64.dmg"
            else
              sha256 "${{ steps.checksums.outputs.ARM_SHA }}"
              url "https://github.com/13shivam/mgm/releases/download/v#{version}/macOS.Gateway.Monitor-#{version}-arm64.dmg"
            end
            
            name "macOS Gateway Monitor"
            desc "macOS security and network monitoring tool with real-time process analysis"
            homepage "https://github.com/13shivam/mgm"
            
            app "macOS Gateway Monitor.app"
            
            zap trash: [
              "~/Library/Application Support/macOS Gateway Monitor",
              "~/Library/Preferences/com.enterprise.macos-gateway-monitor.plist",
              "~/Library/Caches/com.enterprise.macos-gateway-monitor",
            ]
            
            caveats <<~EOS
              ‚ö†Ô∏è  If you see "damaged" error, run:
                sudo xattr -cr "/Applications/macOS Gateway Monitor.app"
              
              Then open the app normally.
              
              For admin privileges (full functionality):
                cd "/Applications/macOS Gateway Monitor.app/Contents/Resources/app"
                ./setup-admin.sh
            EOS
          end
          EOF
          
          echo "üìÑ Generated formula:"
          cat Casks/mgm.rb

      - name: Commit and Push to Tap Repo
        id: commit_formula
        continue-on-error: true
        env:
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/mgm.rb
          
          if git diff --staged --quiet; then
            echo "COMMITTED=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No changes to commit"
          else
            git commit -m "chore: update mgm cask to v${{ steps.version.outputs.VERSION }}"
            git push https://${TAP_TOKEN}@github.com/13shivam/homebrew-mgm.git main
            echo "COMMITTED=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Homebrew tap updated"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
          body: |
            ## macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
            
            ‚ö†Ô∏è **Note:** This app is not code-signed. On first launch:
            1. Right-click the app ‚Üí "Open"
            2. Click "Open" in the security dialog
            3. Or: System Settings ‚Üí Privacy & Security ‚Üí "Open Anyway"
            
            ### Downloads
            ${{ steps.rename.outputs.ARM_BUILT == 'true' && '- ‚úÖ **Apple Silicon (M1/M2/M3)**: macOS-Gateway-Monitor-' || '- ‚ùå Apple Silicon: Not available' }}${{ steps.rename.outputs.ARM_BUILT == 'true' && steps.version.outputs.VERSION || '' }}${{ steps.rename.outputs.ARM_BUILT == 'true' && '-AppleSilicon.dmg' || '' }}
            ${{ steps.rename.outputs.INTEL_BUILT == 'true' && '- ‚úÖ **Intel**: macOS-Gateway-Monitor-' || '- ‚ùå Intel: Not available' }}${{ steps.rename.outputs.INTEL_BUILT == 'true' && steps.version.outputs.VERSION || '' }}${{ steps.rename.outputs.INTEL_BUILT == 'true' && '-Intel.dmg' || '' }}
            
            ### Installation
            
            **Via Homebrew (Recommended):**
            ```bash
            brew tap 13shivam/mgm
            brew install --cask mgm
            ```
            
            **Manual Installation:**
            1. Download the DMG for your Mac architecture
            2. Open the DMG file
            3. Drag "macOS Gateway Monitor.app" to Applications
            4. **Right-click** the app and select "Open" (first time only)
            
            ### Homebrew Formula
            ${{ steps.commit_formula.outputs.COMMITTED == 'true' && '‚úÖ Auto-updated with new checksums' || '‚ö†Ô∏è Manual update needed' }}
            
            ### SHA256 Checksums
            ```
            Apple Silicon: ${{ steps.checksums.outputs.ARM_SHA }}
            Intel: ${{ steps.checksums.outputs.INTEL_SHA }}
            ```
            
            ---
            [Documentation](https://github.com/13shivam/mgm#readme) | [Report Issue](https://github.com/13shivam/mgm/issues)
          files: |
            dist/macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg
            dist/macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
