name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run linter
        run: npm run lint

  build-and-release:
    needs: test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build DMG
        run: npm run build

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Rename DMG files
        run: |
          cd dist
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" ]; then
            mv "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-arm64.dmg" "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg"
          fi
          if [ -f "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" ]; then
            mv "macOS Gateway Monitor-${{ steps.version.outputs.VERSION }}-x64.dmg" "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg"
          fi
          ls -la

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          cd dist
          if [ -f "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg" ]; then
            INTEL_SHA=$(shasum -a 256 "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg" | awk '{print $1}')
            echo "INTEL_SHA=$INTEL_SHA" >> $GITHUB_OUTPUT
            echo "Intel SHA256: $INTEL_SHA"
          else
            echo "INTEL_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
          fi
          if [ -f "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg" ]; then
            ARM_SHA=$(shasum -a 256 "macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg" | awk '{print $1}')
            echo "ARM_SHA=$ARM_SHA" >> $GITHUB_OUTPUT
            echo "Apple Silicon SHA256: $ARM_SHA"
          else
            echo "ARM_SHA=NOT_BUILT" >> $GITHUB_OUTPUT
          fi

      - name: Update Homebrew Formula
        id: update_formula
        run: |
          # Clone the tap repository
          git clone https://github.com/13shivam/homebrew-mgm.git tap-repo
          cd tap-repo
          
          # Create Casks directory if it doesn't exist
          mkdir -p Casks
          
          # Copy and update the formula
          cp ../homebrew/mgm.rb Casks/mgm.rb
          
          # Update version and checksums
          sed -i '' "s/version \".*\"/version \"${{ steps.version.outputs.VERSION }}\"/" Casks/mgm.rb
          
          # Update Intel SHA256 if built
          if [ "${{ steps.checksums.outputs.INTEL_SHA }}" != "NOT_BUILT" ]; then
            sed -i '' "/Hardware::CPU.intel?/,/url.*Intel/ s/sha256 \"[^\"]*\"/sha256 \"${{ steps.checksums.outputs.INTEL_SHA }}\"/" Casks/mgm.rb
          fi
          
          # Update ARM SHA256 if built
          if [ "${{ steps.checksums.outputs.ARM_SHA }}" != "NOT_BUILT" ]; then
            sed -i '' "/else/,/url.*AppleSilicon/ s/sha256 \"[^\"]*\"/sha256 \"${{ steps.checksums.outputs.ARM_SHA }}\"/" Casks/mgm.rb
          fi
          
          echo "Formula updated successfully"
          cat Casks/mgm.rb

      - name: Commit and Push to Tap Repo
        id: commit_formula
        continue-on-error: true
        env:
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/mgm.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "COMMITTED=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update mgm cask to v${{ steps.version.outputs.VERSION }}"
            git push https://${TAP_TOKEN}@github.com/13shivam/homebrew-mgm.git main
            echo "COMMITTED=true" >> $GITHUB_OUTPUT
            echo "✅ Homebrew tap auto-updated"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
          body: |
            ## macOS Gateway Monitor v${{ steps.version.outputs.VERSION }}
            
            ### Downloads
            - **Apple Silicon (M1/M2/M3)**: macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-AppleSilicon.dmg
            - **Intel**: macOS-Gateway-Monitor-${{ steps.version.outputs.VERSION }}-Intel.dmg (if available)
            
            ### Installation
            
            **Via Homebrew:**
            ```bash
            brew tap 13shivam/mgm
            brew install --cask mgm
            ```
            
            **Manual:**
            1. Download the appropriate DMG for your Mac
            2. Open the DMG file
            3. Drag "macOS Gateway Monitor.app" to Applications
            
            ### Homebrew Formula Status
            ${{ steps.commit_formula.outputs.COMMITTED == 'true' && '✅ **Auto-updated** - Formula updated automatically with new checksums' || '⚠️ **Manual update needed** - Update `homebrew/mgm.rb` with checksums below:' }}
            
            ### SHA256 Checksums
            ```
            Apple Silicon: ${{ steps.checksums.outputs.ARM_SHA }}
            Intel: ${{ steps.checksums.outputs.INTEL_SHA }}
            ```
            
            ---
            See [README](https://github.com/13shivam/mgm#readme) for full documentation.
          files: |
            dist/macOS-Gateway-Monitor-*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
